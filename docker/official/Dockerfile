FROM rundeckapp/testdeck:base-latest

RUN apt-get update && \
    apt-get install -y --no-install-recommends wget && \
    rm -r /var/lib/apt/lists/* && \
    # Install confd
    wget https://github.com/kelseyhightower/confd/releases/download/v0.16.0/confd-0.16.0-linux-amd64 && \
    mv confd* /usr/local/bin/confd && \
    chmod ugo+x /usr/local/bin/confd && \
    # Setup rundeck user
    adduser --shell /bin/bash --home /home/rundeck --gecos "" --disabled-password rundeck \
    && passwd -d rundeck \
    && addgroup rundeck sudo

USER rundeck

WORKDIR /home/rundeck

COPY --chown=rundeck:rundeck .build .
COPY --chown=rundeck:rundeck confd /etc/confd

RUN java -jar rundeck.war --installonly

VOLUME ["/home/rundeck/server/data"]

ENV LANG C.UTF-8
ENV LC_ALL C.UTF-8

CMD confd -onetime -backend env && java -XX:+UnlockExperimentalVMOptions -XX:MaxRAMFraction=1 -XX:+UseCGroupMemoryLimitForHeap -jar rundeck.war